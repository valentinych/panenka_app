{% extends "base.html" %}
{% block layout_modifier %} layout--full{% endblock %}
{% block title %}Question Explorer · Panenka Live{% endblock %}
{% block content %}
<section class="card question-card">
  <h2 class="card-title">Question Explorer</h2>
  <p class="card-description">
    Search and filter the trivia database by keywords. Enable AI assistance to expand your query with smart synonyms and related topics.
  </p>
  <form method="get" class="question-search">
    <div class="field">
      <label class="field-label" for="query">Keywords</label>
      <input
        id="query"
        type="text"
        name="q"
        value="{{ query }}"
        placeholder="e.g. футбол, сезон 3, музыка"
      >
    </div>
    <div class="question-search__options">
      <label class="checkbox">
        <input
          type="checkbox"
          name="ai"
          value="1"
          {% if use_ai %}checked{% endif %}
          {% if not ai_enabled %}disabled{% endif %}
        >
        <span>Use AI-assisted keyword expansion</span>
      </label>
      <label class="checkbox checkbox-inline" for="limit">
        <span>Results limit</span>
        <input
          id="limit"
          type="number"
          name="limit"
          min="5"
          max="100"
          value="{{ limit_value }}"
          class="input-number"
        >
      </label>
      <button type="submit" class="btn-primary">Search</button>
    </div>
    <div class="question-search__filters">
      <label class="field field--compact">
        <span class="field-label">Сезон</span>
        <select name="season">
          <option value="" {% if not season_filter %}selected{% endif %}>Все сезоны</option>
          {% for season in seasons %}
            <option value="{{ season }}" {% if season_filter == season %}selected{% endif %}>Сезон {{ season }}</option>
          {% endfor %}
        </select>
      </label>
      <label class="field field--compact">
        <span class="field-label">Номинал</span>
        <select name="value">
          <option value="" {% if not value_filter %}selected{% endif %}>Все номиналы</option>
          {% for value in values %}
            <option value="{{ value }}" {% if value_filter == value %}selected{% endif %}>{{ value }}</option>
          {% endfor %}
        </select>
      </label>
      <label class="field field--compact">
        <span class="field-label">Автор</span>
        <select name="author">
          <option value="" {% if not author_filter %}selected{% endif %}>Все авторы</option>
          {% for author in authors %}
            <option value="{{ author }}" {% if author_filter == author %}selected{% endif %}>{{ author }}</option>
          {% endfor %}
        </select>
      </label>
      <label class="field field--compact">
        <span class="field-label">Редактор</span>
        <select name="editor">
          <option value="" {% if not editor_filter %}selected{% endif %}>Все редакторы</option>
          {% for editor in editors %}
            <option value="{{ editor }}" {% if editor_filter == editor %}selected{% endif %}>{{ editor }}</option>
          {% endfor %}
        </select>
      </label>
    </div>
    <div class="question-search__range-filters">
      <div class="range-filter">
        <span class="field-label">Взято</span>
        <div class="dual-range" data-range-group="taken">
          <input
            type="range"
            name="taken_min"
            min="0"
            max="{{ taken_max_bound }}"
            value="{{ taken_min }}"
            step="1"
            data-role="min"
          >
          <input
            type="range"
            name="taken_max"
            min="0"
            max="{{ taken_max_bound }}"
            value="{{ taken_max }}"
            step="1"
            data-role="max"
          >
          <div class="dual-range__track" aria-hidden="true"></div>
        </div>
        <div class="range-filter__values">
          <span data-role="display-min">{{ taken_min }}</span>
          <span class="range-filter__separator">—</span>
          <span data-role="display-max">{{ taken_max }}</span>
        </div>
      </div>
      <div class="range-filter">
        <span class="field-label">Не взято</span>
        <div class="dual-range" data-range-group="not-taken">
          <input
            type="range"
            name="not_taken_min"
            min="0"
            max="{{ not_taken_max_bound }}"
            value="{{ not_taken_min }}"
            step="1"
            data-role="min"
          >
          <input
            type="range"
            name="not_taken_max"
            min="0"
            max="{{ not_taken_max_bound }}"
            value="{{ not_taken_max }}"
            step="1"
            data-role="max"
          >
          <div class="dual-range__track" aria-hidden="true"></div>
        </div>
        <div class="range-filter__values">
          <span data-role="display-min">{{ not_taken_min }}</span>
          <span class="range-filter__separator">—</span>
          <span data-role="display-max">{{ not_taken_max }}</span>
        </div>
      </div>
    </div>
    {% if not ai_enabled %}
      <p class="helper-text">Set the <code>OPENAI_API_KEY</code> environment variable to unlock AI-powered search.</p>
    {% endif %}
  </form>
  {% if ai_feedback %}
    <p class="helper-text">{{ ai_feedback }}</p>
  {% endif %}
  {% if combined_keywords %}
    <p class="helper-text">Applied keywords: {{ combined_keywords | join(", ") }}</p>
  {% elif not query %}
    <p class="helper-text">Showing the latest {{ result_count }} questions. Enter a search term to refine the list.</p>
  {% endif %}
  {% if results %}
    <div class="table-wrapper">
      <table class="question-table">
        <thead>
          <tr>
            <th scope="col">Season</th>
            <th scope="col">Topic</th>
            <th scope="col">Value</th>
            <th scope="col">Question</th>
            <th scope="col">Answer</th>
            <th scope="col">Author</th>
            <th scope="col">Editor</th>
            <th scope="col">Played</th>
            <th scope="col">Взято / Не взято</th>
            <th scope="col">Комментарии</th>
          </tr>
        </thead>
        <tbody>
          {% for row in results %}
            <tr>
              <td>{{ row.season_number }}</td>
              <td>{{ row.topic or "—" }}</td>
              <td>
                {% if row.question_value %}
                  {{ row.question_value }}
                {% else %}
                  —
                {% endif %}
              </td>
              <td class="question-table__text">{{ row.question_text | default("—") | replace('\n', '<br>') | safe }}</td>
              <td class="question-table__text">{{ row.answer_text | default("—") | replace('\n', '<br>') | safe }}</td>
              <td>{{ row.author or "—" }}</td>
              <td>{{ row.editor or "—" }}</td>
              <td>
                {% if row.played_at %}
                  {{ row.played_at }}
                {% elif row.played_at_raw %}
                  {{ row.played_at_raw }}
                {% else %}
                  —
                {% endif %}
              </td>
              <td>
                {% if row.taken_count is not none or row.not_taken_count is not none %}
                  <div class="taken-indicators">
                    {% if row.taken_count is not none %}
                      <span class="taken-indicator taken-indicator--positive">{{ row.taken_count }}</span>
                    {% endif %}
                    {% if row.not_taken_count is not none %}
                      <span class="taken-indicator taken-indicator--negative">{{ row.not_taken_count }}</span>
                    {% endif %}
                  </div>
                {% else %}
                  —
                {% endif %}
              </td>
              <td class="question-table__text">{{ row.comment | default("—") | replace('\n', '<br>') | safe }}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% else %}
    <p class="helper-text">No questions match this request yet. Try different keywords or broaden the search.</p>
  {% endif %}
</section>
{% endblock %}

{% block extra_scripts %}
  {{ super() }}
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const groups = document.querySelectorAll('.dual-range');
      groups.forEach(function (group) {
        const minInput = group.querySelector('input[data-role="min"]');
        const maxInput = group.querySelector('input[data-role="max"]');
        const track = group.querySelector('.dual-range__track');
        const container = group.parentElement;
        const displayMin = container.querySelector('[data-role="display-min"]');
        const displayMax = container.querySelector('[data-role="display-max"]');

        if (!minInput || !maxInput || !track || !displayMin || !displayMax) {
          return;
        }

        const update = function (changed) {
          let minValue = parseInt(minInput.value || '0', 10);
          let maxValue = parseInt(maxInput.value || '0', 10);

          if (Number.isNaN(minValue)) {
            minValue = 0;
          }
          if (Number.isNaN(maxValue)) {
            maxValue = 0;
          }

          if (minValue > maxValue) {
            if (changed === minInput) {
              maxValue = minValue;
              maxInput.value = String(maxValue);
            } else {
              minValue = maxValue;
              minInput.value = String(minValue);
            }
          }

          displayMin.textContent = String(minValue);
          displayMax.textContent = String(maxValue);

          const maxRange = Math.max(
            Number(minInput.max) || 0,
            Number(maxInput.max) || 0
          );

          const progressStart = maxRange > 0 ? (minValue / maxRange) * 100 : 0;
          const progressEnd = maxRange > 0 ? (maxValue / maxRange) * 100 : 0;
          const groupColor = getComputedStyle(group).getPropertyValue('--range-active').trim();
          const accentColor = getComputedStyle(document.documentElement)
            .getPropertyValue('--accent')
            .trim() || '#ffb703';
          const activeColor = groupColor || accentColor;
          const trackColor = 'rgba(255, 255, 255, 0.18)';

          track.style.background = `linear-gradient(to right, ${trackColor} ${progressStart}%, ${activeColor} ${progressStart}%, ${activeColor} ${progressEnd}%, ${trackColor} ${progressEnd}%)`;
        };

        minInput.addEventListener('input', function () {
          update(minInput);
        });
        maxInput.addEventListener('input', function () {
          update(maxInput);
        });

        update();
      });
    });
  </script>
{% endblock %}
